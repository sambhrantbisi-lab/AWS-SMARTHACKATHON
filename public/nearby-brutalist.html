<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERVICES NEAR ME - BRUTALIST</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/brutalist-style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Brutalist Header -->
    <header class="brutal-header">
        <h1 class="brutal-title">SERVICES NEAR ME</h1>
        <p class="brutal-subtitle">Location-Based Services ‚Ä¢ Real-Time Data ‚Ä¢ OpenStreetMap</p>
        <nav class="brutal-nav">
            <a href="javascript:history.back()" class="brutal-nav-btn">‚Üê BACK</a>
            <a href="/index-brutalist.html" class="brutal-nav-btn">HOME</a>
            <a href="/services-brutalist.html" class="brutal-nav-btn">SERVICES</a>
            <a href="/stocks-brutalist.html" class="brutal-nav-btn">STOCKS</a>
            <a href="/market-brutalist.html" class="brutal-nav-btn">MARKET</a>
            <a href="/nearby-brutalist.html" class="brutal-nav-btn active">NEARBY</a>
            <a href="/login-brutalist.html" class="brutal-nav-btn">LOGIN</a>
            <select class="brutal-select" id="languageSelector" onchange="changeLanguage(this.value)">
                <option value="en">ENGLISH</option>
                <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
            </select>
            <button class="brutal-btn" onclick="toggleAccessibility()" style="padding: 10px 15px;">
                ‚öôÔ∏è ACCESSIBILITY
            </button>
        </nav>
    </header>

    <!-- Accessibility Panel -->
    <div class="accessibility-panel" id="accessibilityPanel">
        <h3>‚öôÔ∏è SETTINGS</h3>
        
        <div class="accessibility-option">
            <label>Theme</label>
            <div class="accessibility-buttons">
                <button class="accessibility-btn active" onclick="setTheme('light')" id="lightBtn">
                    ‚òÄÔ∏è LIGHT
                </button>
                <button class="accessibility-btn" onclick="setTheme('dark')" id="darkBtn">
                    üåô DARK
                </button>
            </div>
        </div>

        <div class="accessibility-option">
            <label>Font Size</label>
            <div class="accessibility-buttons">
                <button class="accessibility-btn" onclick="setFontSize('small')">
                    A-
                </button>
                <button class="accessibility-btn active" onclick="setFontSize('normal')" id="normalFontBtn">
                    A
                </button>
                <button class="accessibility-btn" onclick="setFontSize('large')">
                    A+
                </button>
                <button class="accessibility-btn" onclick="setFontSize('xlarge')">
                    A++
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="brutal-container">
        <!-- Location Status -->
        <div id="locationStatus" style="background: #fff; border: 6px solid #000; padding: 30px; margin-bottom: 30px; text-align: center;">
            <div class="brutal-icon">üìç</div>
            <h2 style="font-family: 'Space Mono', monospace; font-size: 24px; margin-bottom: 15px;">
                ENABLE LOCATION ACCESS
            </h2>
            <p style="margin-bottom: 20px; color: #808080;">
                We need your location to find nearby services. Your location data is not stored.
            </p>
            <button class="brutal-btn" onclick="requestLocation()">
                üìç GET MY LOCATION
            </button>
            
            <div style="margin-top: 30px; padding-top: 30px; border-top: 4px solid #000;">
                <p style="font-family: 'Space Mono', monospace; font-size: 14px; margin-bottom: 15px;">
                    OR ENTER LOCATION MANUALLY
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <input type="text" id="manualLat" placeholder="Latitude (e.g., 28.6139)" 
                           style="padding: 10px; border: 3px solid #000; font-family: 'Space Mono', monospace; width: 200px;">
                    <input type="text" id="manualLon" placeholder="Longitude (e.g., 77.2090)" 
                           style="padding: 10px; border: 3px solid #000; font-family: 'Space Mono', monospace; width: 200px;">
                    <button class="brutal-btn" onclick="useManualLocation()">
                        ‚úì USE LOCATION
                    </button>
                </div>
                <p style="font-size: 12px; color: #808080; margin-top: 10px;">
                    Example: Delhi (28.6139, 77.2090) ‚Ä¢ Mumbai (19.0760, 72.8777) ‚Ä¢ Bangalore (12.9716, 77.5946)
                </p>
            </div>
        </div>

        <!-- Map Container -->
        <div id="mapContainer" style="display: none; margin-bottom: 30px;">
            <div style="background: #fff; border: 6px solid #000; padding: 20px;">
                <h3 style="font-family: 'Space Mono', monospace; font-size: 20px; margin-bottom: 15px;">
                    üìç YOUR LOCATION
                </h3>
                <div id="map" style="height: 400px; border: 4px solid #000;"></div>
                <p id="locationInfo" style="margin-top: 15px; font-family: 'Space Mono', monospace; font-size: 14px;"></p>
            </div>
        </div>

        <!-- Category Filter -->
        <div id="categoryFilter" style="display: none; background: #fff; border: 6px solid #000; padding: 20px; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="font-family: 'Space Mono', monospace; font-size: 18px; margin: 0;">
                    üîç SELECT SERVICES
                </h3>
                <button class="brutal-btn" onclick="resetCategories()" style="padding: 8px 15px; font-size: 12px;">
                    üîÑ RESET
                </button>
            </div>
            
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="brutal-input" 
                    placeholder="What are you looking for? (e.g., hospital, pharmacy, restaurant, atm, bank, police, school, park, fuel)"
                    style="flex: 1; font-size: 14px; padding: 12px;"
                    onkeypress="if(event.key==='Enter') searchNearby()"
                />
                <button class="brutal-btn" onclick="searchNearby()" style="padding: 12px 20px; white-space: nowrap;">
                    üîç SEARCH
                </button>
            </div>
            
            <p style="font-size: 12px; color: #666; margin-bottom: 20px; font-family: 'Space Grotesk', sans-serif;">
                üí° Examples: hospital, pharmacy, restaurant, atm, bank, police, fire station, school, park, fuel station
            </p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" style="display: none; text-align: center; padding: 60px;">
            <div class="brutal-loading" style="width: 60px; height: 60px; border-width: 6px;"></div>
            <p style="font-family: 'Space Mono', monospace; font-size: 18px; margin-top: 20px; text-transform: uppercase;">
                SEARCHING NEARBY SERVICES...
            </p>
        </div>

        <!-- Results by Distance -->
        <div id="resultsContainer" style="display: none;">
            <!-- AI Recommendations -->
            <div id="aiRecommendations" style="margin-bottom: 40px;">
                <h2 style="font-family: 'Space Mono', monospace; font-size: 28px; margin-bottom: 20px; color: #7b2cbf;">
                    ü§ñ AI RECOMMENDATIONS
                </h2>
                <div class="brutal-grid" id="aiRecommendationsGrid"></div>
            </div>

            <!-- Within 5km -->
            <div id="results5km" class="distance-group">
                <h2 style="font-family: 'Space Mono', monospace; font-size: 28px; margin-bottom: 20px; color: #00FF00;">
                    üìç WITHIN 5 KM
                </h2>
                <div class="brutal-grid" id="grid5km"></div>
            </div>

            <!-- Within 10km -->
            <div id="results10km" class="distance-group" style="margin-top: 40px;">
                <h2 style="font-family: 'Space Mono', monospace; font-size: 28px; margin-bottom: 20px; color: #FFFF00;">
                    üìç 5-10 KM
                </h2>
                <div class="brutal-grid" id="grid10km"></div>
            </div>

            <!-- Within 50km -->
            <div id="results50km" class="distance-group" style="margin-top: 40px;">
                <h2 style="font-family: 'Space Mono', monospace; font-size: 28px; margin-bottom: 20px; color: #FF0000;">
                    üìç 10-50 KM
                </h2>
                <div class="brutal-grid" id="grid50km"></div>
            </div>
        </div>
    </div>

    <!-- Language Manager -->
    <script src="/language-manager.js?v=1.0"></script>
    
    <!-- AI Chat Floating Window -->
    <script src="/ai-chat-floating.js?v=2.1"></script>

    <script>
        let userLocation = null;
        let map = null;
        let markers = [];
        let selectedCategories = new Set();
        let allPlacesData = {}; // Store all place data by tile ID for AI context

        // Category definitions for Overpass API
        const categoryQueries = {
            hospital: 'node["amenity"="hospital"]',
            police: 'node["amenity"="police"]',
            fire_station: 'node["amenity"="fire_station"]',
            pharmacy: 'node["amenity"="pharmacy"]',
            bank: 'node["amenity"="bank"]',
            atm: 'node["amenity"="atm"]',
            restaurant: 'node["amenity"="restaurant"]',
            fuel: 'node["amenity"="fuel"]',
            school: 'node["amenity"="school"]',
            park: 'node["leisure"="park"]'
        };

        const categoryIcons = {
            hospital: 'üè•',
            police: 'üëÆ',
            fire_station: 'üöí',
            pharmacy: 'üíä',
            bank: 'üè¶',
            atm: 'üí≥',
            restaurant: 'üçΩÔ∏è',
            fuel: '‚õΩ',
            school: 'üè´',
            park: 'üå≥'
        };

        // Request location
        function requestLocation() {
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser. Please enter location manually.');
                return;
            }

            document.getElementById('locationStatus').innerHTML = `
                <div class="brutal-loading" style="width: 60px; height: 60px; border-width: 6px; margin: 0 auto 20px;"></div>
                <p style="font-family: 'Space Mono', monospace; font-size: 18px;">
                    GETTING YOUR LOCATION...
                </p>
                <p style="font-size: 14px; color: #808080; margin-top: 10px;">
                    Please allow location access in your browser
                </p>
            `;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    console.log('‚úÖ GPS Location obtained:', userLocation);
                    console.log('üìç Accuracy:', position.coords.accuracy, 'meters');
                    console.log('üìç Altitude:', position.coords.altitude);
                    console.log('üìç Heading:', position.coords.heading);
                    console.log('üìç Speed:', position.coords.speed);
                    console.log('üìç Timestamp:', new Date(position.timestamp).toLocaleString());
                    
                    // Check if accuracy is poor (> 1000 meters = 1km)
                    if (position.coords.accuracy > 1000) {
                        console.warn('‚ö†Ô∏è Poor GPS accuracy detected:', position.coords.accuracy, 'meters');
                        console.warn('This is likely WiFi/IP-based location, not GPS');
                        
                        // Show warning to user
                        const warningDiv = document.createElement('div');
                        warningDiv.style.cssText = 'background: #FFA500; color: #000; border: 4px solid #000; padding: 20px; margin-bottom: 20px; font-family: "Space Mono", monospace;';
                        warningDiv.innerHTML = `
                            <strong style="font-size: 18px;">‚ö†Ô∏è LOW ACCURACY WARNING</strong><br><br>
                            <p style="margin: 10px 0;">
                                Your location accuracy is ¬±${Math.round(position.coords.accuracy / 1000)} km. 
                                This means the browser is using WiFi/IP-based location instead of GPS.
                            </p>
                            <p style="margin: 10px 0; font-size: 14px;">
                                <strong>To get precise GPS location:</strong><br>
                                1. Enable GPS/Location Services on your device<br>
                                2. Go outdoors or near a window for better GPS signal<br>
                                3. Access this site via HTTPS (not HTTP)<br>
                                4. Wait 30-60 seconds for GPS to acquire satellites<br>
                                5. Or use manual coordinate entry below
                            </p>
                            <button class="brutal-btn" onclick="this.parentElement.remove(); requestLocation();" style="margin-top: 10px;">
                                üîÑ TRY AGAIN WITH GPS
                            </button>
                            <button class="brutal-btn" onclick="this.parentElement.remove(); document.getElementById('manualLat').focus();" style="margin-top: 10px; margin-left: 10px; background: #7b2cbf;">
                                üìù USE MANUAL ENTRY
                            </button>
                        `;
                        
                        const container = document.querySelector('.brutal-container');
                        container.insertBefore(warningDiv, container.firstChild);
                    }
                    
                    document.getElementById('locationStatus').style.display = 'none';
                    document.getElementById('mapContainer').style.display = 'block';
                    document.getElementById('categoryFilter').style.display = 'block';
                    
                    initMap();
                },
                (error) => {
                    console.error('‚ùå Geolocation error:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    let errorMsg = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location permission denied. Please allow location access in browser settings or use manual entry below.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information unavailable. This can happen if GPS is disabled, you\'re indoors, or the device cannot determine location. Please check your device location settings or use manual entry below.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out after 30 seconds. GPS may be taking longer than usual. Please try again or use manual entry below.';
                            break;
                        default:
                            errorMsg = 'An unknown error occurred. Please use manual entry below.';
                    }
                    
                    showError(errorMsg);
                },
                {
                    enableHighAccuracy: true,  // Force GPS instead of WiFi/cell tower triangulation
                    timeout: 30000,            // 30 seconds for precise GPS
                    maximumAge: 0              // Don't use cached location - get fresh GPS fix
                }
            );
        }

        // Show error with manual entry option
        function showError(message) {
            document.getElementById('locationStatus').innerHTML = `
                <div class="brutal-icon">‚ö†Ô∏è</div>
                <h2 style="font-family: 'Space Mono', monospace; font-size: 24px; margin-bottom: 15px; color: #FF0000;">
                    LOCATION ACCESS ISSUE
                </h2>
                <p style="margin-bottom: 20px; color: #808080;">
                    ${message}
                </p>
                <button class="brutal-btn" onclick="requestLocation()">
                    üìç TRY AGAIN
                </button>
                
                <div style="margin-top: 30px; padding-top: 30px; border-top: 4px solid #000;">
                    <p style="font-family: 'Space Mono', monospace; font-size: 14px; margin-bottom: 15px;">
                        OR ENTER LOCATION MANUALLY
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <input type="text" id="manualLat" placeholder="Latitude (e.g., 28.6139)" 
                               style="padding: 10px; border: 3px solid #000; font-family: 'Space Mono', monospace; width: 200px;">
                        <input type="text" id="manualLon" placeholder="Longitude (e.g., 77.2090)" 
                               style="padding: 10px; border: 3px solid #000; font-family: 'Space Mono', monospace; width: 200px;">
                        <button class="brutal-btn" onclick="useManualLocation()">
                            ‚úì USE LOCATION
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #808080; margin-top: 10px;">
                        Example: Delhi (28.6139, 77.2090) ‚Ä¢ Mumbai (19.0760, 72.8777) ‚Ä¢ Bangalore (12.9716, 77.5946)
                    </p>
                </div>
            `;
        }

        // Use manual location
        function useManualLocation() {
            const lat = parseFloat(document.getElementById('manualLat').value);
            const lon = parseFloat(document.getElementById('manualLon').value);
            
            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid latitude and longitude values');
                return;
            }
            
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                alert('Invalid coordinates. Latitude must be between -90 and 90, Longitude between -180 and 180');
                return;
            }
            
            userLocation = { lat, lon };
            
            console.log('Manual location set:', userLocation);
            
            document.getElementById('locationStatus').style.display = 'none';
            document.getElementById('mapContainer').style.display = 'block';
            document.getElementById('categoryFilter').style.display = 'block';
            
            initMap();
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([userLocation.lat, userLocation.lon], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add user location marker
            const userMarker = L.marker([userLocation.lat, userLocation.lon], {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background: #FF0000; width: 20px; height: 20px; border-radius: 50%; border: 4px solid #fff; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(map);

            userMarker.bindPopup('<strong>üìç YOUR LOCATION</strong>').openPopup();

            // Get location name
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lon}`)
                .then(res => res.json())
                .then(data => {
                    let accuracyInfo = '';
                    let accuracyColor = '#00FF00'; // Green for good
                    let accuracyLabel = 'EXCELLENT';
                    
                    if (userLocation.accuracy) {
                        const accuracyMeters = Math.round(userLocation.accuracy);
                        
                        if (accuracyMeters < 50) {
                            accuracyColor = '#00FF00';
                            accuracyLabel = 'EXCELLENT';
                        } else if (accuracyMeters < 200) {
                            accuracyColor = '#7FFF00';
                            accuracyLabel = 'GOOD';
                        } else if (accuracyMeters < 1000) {
                            accuracyColor = '#FFFF00';
                            accuracyLabel = 'FAIR';
                        } else if (accuracyMeters < 5000) {
                            accuracyColor = '#FFA500';
                            accuracyLabel = 'POOR';
                        } else {
                            accuracyColor = '#FF0000';
                            accuracyLabel = 'VERY POOR';
                        }
                        
                        accuracyInfo = `<br><strong>GPS Accuracy:</strong> <span style="color: ${accuracyColor}; font-weight: bold;">¬±${accuracyMeters}m (${accuracyLabel})</span>`;
                    }
                    
                    document.getElementById('locationInfo').innerHTML = `
                        <strong>Location:</strong> ${data.display_name}<br>
                        <strong>Coordinates:</strong> ${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}${accuracyInfo}
                    `;
                })
                .catch(err => {
                    let accuracyInfo = '';
                    let accuracyColor = '#00FF00';
                    let accuracyLabel = 'EXCELLENT';
                    
                    if (userLocation.accuracy) {
                        const accuracyMeters = Math.round(userLocation.accuracy);
                        
                        if (accuracyMeters < 50) {
                            accuracyColor = '#00FF00';
                            accuracyLabel = 'EXCELLENT';
                        } else if (accuracyMeters < 200) {
                            accuracyColor = '#7FFF00';
                            accuracyLabel = 'GOOD';
                        } else if (accuracyMeters < 1000) {
                            accuracyColor = '#FFFF00';
                            accuracyLabel = 'FAIR';
                        } else if (accuracyMeters < 5000) {
                            accuracyColor = '#FFA500';
                            accuracyLabel = 'POOR';
                        } else {
                            accuracyColor = '#FF0000';
                            accuracyLabel = 'VERY POOR';
                        }
                        
                        accuracyInfo = `<br><strong>GPS Accuracy:</strong> <span style="color: ${accuracyColor}; font-weight: bold;">¬±${accuracyMeters}m (${accuracyLabel})</span>`;
                    }
                    
                    document.getElementById('locationInfo').innerHTML = `
                        <strong>Coordinates:</strong> ${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}${accuracyInfo}
                    `;
                });
        }

        // Toggle category selection
        function toggleCategory(category) {
            const btn = document.querySelector(`[data-category="${category}"]`);
            
            if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
                btn.classList.remove('selected');
            } else {
                selectedCategories.add(category);
                btn.classList.add('selected');
            }
        }

        // Reset search
        function resetCategories() {
            // Clear search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Clear results
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('grid5km').innerHTML = '';
            document.getElementById('grid10km').innerHTML = '';
            document.getElementById('grid50km').innerHTML = '';
            document.getElementById('aiRecommendationsGrid').innerHTML = '';
            
            // Clear markers from map
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Reset map view to user location
            if (userLocation && map) {
                map.setView([userLocation.lat, userLocation.lon], 13);
            }
        }

        // Get AI suggestions based on time and context
        async function getAISuggestions() {
            const suggestionsDiv = document.getElementById('aiSuggestionsContent');
            suggestionsDiv.innerHTML = '<div class="brutal-loading" style="width: 20px; height: 20px; border-width: 3px; display: inline-block;"></div> Getting AI suggestions...';
            
            try {
                const now = new Date();
                const hour = now.getHours();
                const day = now.getDay(); // 0 = Sunday, 6 = Saturday
                const isWeekend = day === 0 || day === 6;
                
                const context = {
                    currentTime: now.toISOString(),
                    hour: hour,
                    isWeekend: isWeekend,
                    dayOfWeek: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][day],
                    location: userLocation,
                    availableCategories: Object.keys(categoryQueries)
                };
                
                const response = await fetch('/api/ai/ai-query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Based on the current time (${hour}:00 on ${context.dayOfWeek}), suggest 3-5 most relevant service categories from this list: ${context.availableCategories.join(', ')}. Consider what people typically need at this time. Respond with just the category names separated by commas, and a brief reason.`,
                        context: context
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    suggestionsDiv.innerHTML = `
                        <strong>üí° Recommended for ${hour}:00 on ${context.dayOfWeek}:</strong><br>
                        ${data.response}
                    `;
                } else {
                    throw new Error('AI service unavailable');
                }
            } catch (error) {
                console.error('AI suggestions error:', error);
                
                // Fallback to time-based logic
                const hour = new Date().getHours();
                let suggestions = [];
                
                if (hour >= 6 && hour < 9) {
                    suggestions = ['pharmacy', 'restaurant', 'fuel'];
                    suggestionsDiv.innerHTML = `<strong>üåÖ Morning (${hour}:00):</strong> People often need pharmacies, breakfast restaurants, and fuel stations.`;
                } else if (hour >= 9 && hour < 12) {
                    suggestions = ['bank', 'atm', 'hospital'];
                    suggestionsDiv.innerHTML = `<strong>‚òÄÔ∏è Morning (${hour}:00):</strong> Banks and ATMs are open, good time for medical appointments.`;
                } else if (hour >= 12 && hour < 14) {
                    suggestions = ['restaurant', 'pharmacy', 'atm'];
                    suggestionsDiv.innerHTML = `<strong>üçΩÔ∏è Lunch (${hour}:00):</strong> Restaurants are busy, pharmacies for quick errands.`;
                } else if (hour >= 14 && hour < 18) {
                    suggestions = ['bank', 'school', 'park'];
                    suggestionsDiv.innerHTML = `<strong>üå§Ô∏è Afternoon (${hour}:00):</strong> Banks still open, school pickup time, parks for recreation.`;
                } else if (hour >= 18 && hour < 22) {
                    suggestions = ['restaurant', 'pharmacy', 'fuel'];
                    suggestionsDiv.innerHTML = `<strong>üåÜ Evening (${hour}:00):</strong> Dinner time, 24-hour pharmacies, fuel stations.`;
                } else {
                    suggestions = ['pharmacy', 'hospital', 'fuel'];
                    suggestionsDiv.innerHTML = `<strong>üåô Night (${hour}:00):</strong> 24-hour pharmacies, emergency hospitals, fuel stations.`;
                }
                
                // Auto-select suggested categories
                suggestions.forEach(cat => {
                    if (!selectedCategories.has(cat)) {
                        toggleCategory(cat);
                    }
                });
            }
        }

        // Refine a single AI recommendation
        async function refineSingleRecommendation(tileId) {
            const input = document.getElementById(`${tileId}-refine-input`);
            const chatContainer = document.getElementById(`${tileId}-chat`);
            const userQuery = input.value.trim();
            
            if (!userQuery) {
                alert('Please enter a question (e.g., "has parking", "open now", "wheelchair accessible")');
                return;
            }
            
            // Get the full place data
            const placeData = allPlacesData[tileId];
            if (!placeData) {
                console.error('Place data not found for', tileId);
                return;
            }
            
            // Add user message to chat
            const userMsgDiv = document.createElement('div');
            userMsgDiv.style.cssText = 'background: #7b2cbf; color: #fff; padding: 10px; margin-bottom: 10px; border: 2px solid #000; font-size: 13px;';
            userMsgDiv.innerHTML = `<strong>You:</strong> ${userQuery.replace(/[<>&"']/g, c => ({'<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'})[c])}`;
            chatContainer.appendChild(userMsgDiv);
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'ai-chat-loading';
            loadingDiv.innerHTML = '<div class="brutal-loading" style="width: 16px; height: 16px; border-width: 2px; display: inline-block;"></div> AI is thinking...';
            chatContainer.appendChild(loadingDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Clear input
            input.value = '';
            
            try {
                // Prepare comprehensive context for AI
                const context = {
                    place: {
                        name: placeData.name,
                        category: placeData.category,
                        distance: placeData.distance.toFixed(2) + ' km',
                        address: placeData.address,
                        coordinates: { lat: placeData.lat, lon: placeData.lon },
                        openingHours: placeData.openingHours || 'Not available',
                        phone: placeData.phone || 'Not available',
                        email: placeData.email || 'Not available',
                        website: placeData.website || 'Not available',
                        wheelchair: placeData.wheelchair || 'Unknown',
                        brand: placeData.brand || 'Independent',
                        operator: placeData.operator || 'Unknown',
                        cuisine: placeData.cuisine || 'N/A',
                        capacity: placeData.capacity || 'Unknown',
                        rating: placeData.rating || 'Not rated',
                        // Include all available tags
                        allTags: placeData.tags || {}
                    },
                    userQuery: userQuery,
                    currentTime: new Date().toISOString(),
                    userLocation: userLocation
                };
                
                // Build simple, direct message (let backend handle instructions)
                let detailedMessage = userQuery;
                
                const response = await fetch('/api/ai/ai-query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: detailedMessage,
                        context: context,
                        enableWebSearch: true // Enable web search for current information
                    })
                });
                
                // Remove loading indicator
                chatContainer.removeChild(loadingDiv);
                
                if (response.ok) {
                    const data = await response.json();
                    const safeResponse = data.response.replace(/[<>&"']/g, c => ({
                        '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
                    })[c]);
                    
                    const aiMsgDiv = document.createElement('div');
                    aiMsgDiv.className = 'ai-chat-response';
                    aiMsgDiv.innerHTML = `<strong style="color: #7b2cbf;">ü§ñ AI:</strong><br>${safeResponse}`;
                    chatContainer.appendChild(aiMsgDiv);
                } else {
                    throw new Error('AI service unavailable');
                }
            } catch (error) {
                console.error('AI refinement error:', error);
                
                // Remove loading indicator
                if (chatContainer.contains(loadingDiv)) {
                    chatContainer.removeChild(loadingDiv);
                }
                
                // Fallback: provide smart suggestions based on keywords and available data
                const queryLower = userQuery.toLowerCase();
                let advice = '';
                
                if (queryLower.includes('parking')) {
                    advice = placeData.tags?.parking 
                        ? `This location has parking: ${placeData.tags.parking}. ` 
                        : 'Parking information is not available in our data. ';
                    advice += 'Call ahead to confirm parking availability and any fees.';
                } else if (queryLower.includes('open') || queryLower.includes('hours') || queryLower.includes('timing')) {
                    // Check both direct field and tags
                    const hoursData = placeData.openingHours || placeData.tags?.opening_hours;
                    
                    if (hoursData) {
                        advice = `üïê Opening hours: ${hoursData}. Note that hours may vary on holidays or special occasions.`;
                    } else {
                        advice = '‚ùì Opening hours are not specified in OpenStreetMap data. ';
                        if (placeData.phone) {
                            advice += `Call ${placeData.phone} to confirm current hours and any holiday schedules.`;
                        } else {
                            advice += 'Call ahead to confirm current hours and any holiday schedules.';
                        }
                    }
                } else if (queryLower.includes('wheelchair') || queryLower.includes('accessible')) {
                    // Check both direct field and tags
                    const wheelchairData = placeData.wheelchair || placeData.tags?.wheelchair;
                    
                    if (wheelchairData === 'yes') {
                        advice = '‚úÖ Yes, this location is wheelchair accessible according to OpenStreetMap data.';
                    } else if (wheelchairData === 'no') {
                        advice = '‚ùå According to OpenStreetMap, this location may not be wheelchair accessible. However, I recommend calling ahead to confirm current accessibility features.';
                    } else if (wheelchairData === 'limited') {
                        advice = '‚ö†Ô∏è This location has limited wheelchair accessibility. Call ahead to discuss specific accessibility needs.';
                    } else {
                        advice = '‚ùì Wheelchair accessibility information is not specified in OpenStreetMap data. ';
                        if (placeData.phone) {
                            advice += `I strongly recommend calling ${placeData.phone} to ask about ramps, elevators, accessible restrooms, and other accessibility features.`;
                        } else {
                            advice += 'Call ahead to ask about ramps, elevators, accessible restrooms, and other accessibility features.';
                        }
                    }
                } else if (queryLower.includes('price') || queryLower.includes('cost')) {
                    advice = 'Pricing information is not available in our data. ';
                    if (placeData.website) {
                        advice += 'Check their website or call to inquire about pricing.';
                    } else if (placeData.phone) {
                        advice += 'Call them to inquire about pricing and fees.';
                    } else {
                        advice += 'Visit the location for pricing information.';
                    }
                } else if (queryLower.includes('quality') || queryLower.includes('review')) {
                    advice = placeData.brand 
                        ? `This is a ${placeData.brand} location, which typically indicates consistent quality. `
                        : 'This appears to be an independent location. ';
                    advice += 'Check online reviews or ask locals for quality feedback.';
                } else {
                    advice = `For "${userQuery}", `;
                    if (placeData.phone) {
                        advice += `call ${placeData.phone} for accurate information.`;
                    } else if (placeData.website) {
                        advice += 'check their website for more details.';
                    } else {
                        advice += 'visit the location directly for more information.';
                    }
                }
                
                const aiMsgDiv = document.createElement('div');
                aiMsgDiv.className = 'ai-chat-response';
                aiMsgDiv.innerHTML = `<strong style="color: #7b2cbf;">ü§ñ AI:</strong><br>${advice}`;
                chatContainer.appendChild(aiMsgDiv);
                
                // Log error for debugging
                console.log('‚ö†Ô∏è AI service failed, using local data fallback. Error:', error.message);
            }
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Refine AI recommendations with custom query (legacy - not used anymore)
        async function refineAIRecommendations() {
            const refinementInput = document.getElementById('aiRefinementInput');
            const grid = document.getElementById('aiRecommendationsGrid');
            const userQuery = refinementInput.value.trim();
            
            if (!userQuery) {
                alert('Please enter a refinement query (e.g., "best for families", "open late", "has parking")');
                return;
            }
            
            grid.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="brutal-loading" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 20px;"></div><p style="font-family: \'Space Mono\', monospace;">AI is refining recommendations based on: "<strong>' + userQuery + '</strong>"...</p></div>';
            
            try {
                // Get all current results
                const allGrids = ['grid5km', 'grid10km', 'grid50km'];
                const allPlaces = [];
                
                // Collect all places from the grids (we need to re-fetch or store them)
                // For now, we'll work with what's visible
                allGrids.forEach(gridId => {
                    const gridElement = document.getElementById(gridId);
                    if (gridElement && gridElement.children.length > 0) {
                        // Places are already displayed, we need to get them from our stored data
                        // This is a limitation - ideally we'd store the places globally
                    }
                });
                
                // Since we don't have easy access to the places data after display,
                // we'll ask AI to analyze the selected categories with the refinement
                const context = {
                    selectedCategories: Array.from(selectedCategories),
                    userRefinement: userQuery,
                    location: userLocation,
                    currentTime: new Date().toISOString()
                };
                
                const response = await fetch('/api/ai/ai-query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `User is looking for ${Array.from(selectedCategories).join(', ')} and wants to refine by: "${userQuery}". Provide 3-5 specific recommendations on what to look for in these categories based on the user's refinement. Be specific about features, characteristics, or qualities they should prioritize. Format as a numbered list with brief explanations.`,
                        context: context
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    grid.innerHTML = `
                        <div class="brutal-card" style="border: 6px solid #7b2cbf !important; background: #fff !important; grid-column: 1 / -1;">
                            <div class="brutal-card-header" style="background: #7b2cbf !important; color: #fff !important;">
                                <h3 style="font-size: 20px; margin: 0; color: #fff !important; font-family: 'Space Mono', monospace;">
                                    üéØ REFINED AI RECOMMENDATIONS
                                </h3>
                                <p style="font-size: 14px; color: #c77dff !important; margin-top: 5px;">
                                    Based on your query: "${userQuery}"
                                </p>
                            </div>
                            <div class="brutal-card-body" style="background: #fff !important; color: #000 !important; padding: 30px;">
                                <div style="background: #f0f0f0; border: 3px solid #7b2cbf; padding: 20px; margin-bottom: 20px;">
                                    <div style="color: #7b2cbf; font-family: 'Space Mono', monospace; font-weight: 700; font-size: 16px; margin-bottom: 15px;">
                                        ü§ñ AI Analysis:
                                    </div>
                                    <div style="font-size: 15px; line-height: 1.8; color: #000 !important; white-space: pre-line;">
                                        ${data.response.replace(/[<>&"']/g, c => ({'<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'})[c])}
                                    </div>
                                </div>
                                
                                <div style="padding: 15px; background: #fff; border: 3px solid #000;">
                                    <strong style="font-family: 'Space Mono', monospace; color: #7b2cbf;">üí° Next Steps:</strong>
                                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                                        <li>Review the places in the sections below</li>
                                        <li>Look for the features mentioned in the AI analysis</li>
                                        <li>Click on any place to see it on the map</li>
                                        <li>Check opening hours and contact information</li>
                                    </ul>
                                </div>
                                
                                <button class="brutal-btn" onclick="document.getElementById('aiRefinementInput').value = ''; searchNearby();" style="margin-top: 20px; width: 100%;">
                                    üîÑ CLEAR REFINEMENT & SEARCH AGAIN
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error('AI service unavailable');
                }
            } catch (error) {
                console.error('AI refinement error:', error);
                
                // Fallback: provide smart suggestions based on keywords
                const queryLower = userQuery.toLowerCase();
                let advice = '';
                
                if (queryLower.includes('family') || queryLower.includes('families') || queryLower.includes('kids') || queryLower.includes('children')) {
                    advice = `
                        <strong>For Family-Friendly Options:</strong>
                        <ul>
                            <li>Look for places with high ratings and good reviews</li>
                            <li>Check for wheelchair accessibility (‚ôø icon)</li>
                            <li>Parks with playgrounds and open spaces</li>
                            <li>Restaurants with kid-friendly menus</li>
                            <li>Facilities with parking available</li>
                        </ul>
                    `;
                } else if (queryLower.includes('late') || queryLower.includes('night') || queryLower.includes('24') || queryLower.includes('emergency')) {
                    advice = `
                        <strong>For Late Hours / 24/7 Services:</strong>
                        <ul>
                            <li>Look for "24/7" or "24 hours" in opening hours</li>
                            <li>Pharmacies often have 24-hour locations</li>
                            <li>Hospitals have emergency services available</li>
                            <li>Fuel stations typically open late or 24/7</li>
                            <li>Check the üïê Hours information on each place</li>
                        </ul>
                    `;
                } else if (queryLower.includes('parking') || queryLower.includes('drive')) {
                    advice = `
                        <strong>For Places with Parking:</strong>
                        <ul>
                            <li>Banks usually have parking lots</li>
                            <li>Larger restaurants often provide parking</li>
                            <li>Fuel stations have easy parking access</li>
                            <li>Shopping areas typically have parking facilities</li>
                            <li>Check distance - closer places may have street parking</li>
                        </ul>
                    `;
                } else if (queryLower.includes('quick') || queryLower.includes('fast') || queryLower.includes('urgent')) {
                    advice = `
                        <strong>For Quick Service:</strong>
                        <ul>
                            <li>ATMs for fast cash withdrawal</li>
                            <li>Pharmacies for quick medication pickup</li>
                            <li>Fuel stations for quick fill-ups</li>
                            <li>Choose places within 5km for fastest access</li>
                            <li>Check if they're currently open (üü¢ OPEN status)</li>
                        </ul>
                    `;
                } else if (queryLower.includes('wheelchair') || queryLower.includes('accessible') || queryLower.includes('disability')) {
                    advice = `
                        <strong>For Wheelchair Accessibility:</strong>
                        <ul>
                            <li>Look for the ‚ôø ACCESSIBLE tag on places</li>
                            <li>Modern hospitals and banks are usually accessible</li>
                            <li>Parks with paved paths are wheelchair-friendly</li>
                            <li>Call ahead to confirm accessibility features</li>
                            <li>Newer establishments typically have better access</li>
                        </ul>
                    `;
                } else {
                    advice = `
                        <strong>General Recommendations for "${userQuery}":</strong>
                        <ul>
                            <li>Review the distance to find the closest options</li>
                            <li>Check opening hours to ensure they're available</li>
                            <li>Look for contact information to call ahead</li>
                            <li>Consider brand names for consistent quality</li>
                            <li>Use the map to see exact locations</li>
                        </ul>
                    `;
                }
                
                grid.innerHTML = `
                    <div class="brutal-card" style="border: 6px solid #7b2cbf !important; background: #fff !important; grid-column: 1 / -1;">
                        <div class="brutal-card-header" style="background: #7b2cbf !important; color: #fff !important;">
                            <h3 style="font-size: 20px; margin: 0; color: #fff !important; font-family: 'Space Mono', monospace;">
                                üéØ REFINED RECOMMENDATIONS
                            </h3>
                            <p style="font-size: 14px; color: #c77dff !important; margin-top: 5px;">
                                Based on your query: "${userQuery}"
                            </p>
                        </div>
                        <div class="brutal-card-body" style="background: #fff !important; color: #000 !important; padding: 30px;">
                            <div style="background: #f0f0f0; border: 3px solid #7b2cbf; padding: 20px; margin-bottom: 20px;">
                                <div style="color: #7b2cbf; font-family: 'Space Mono', monospace; font-weight: 700; font-size: 16px; margin-bottom: 15px;">
                                    üí° Smart Suggestions:
                                </div>
                                <div style="font-size: 15px; line-height: 1.8; color: #000 !important;">
                                    ${advice}
                                </div>
                            </div>
                            
                            <div style="padding: 15px; background: #fff; border: 3px solid #000;">
                                <strong style="font-family: 'Space Mono', monospace; color: #7b2cbf;">üí° Next Steps:</strong>
                                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                                    <li>Review the places in the sections below</li>
                                    <li>Look for the features mentioned above</li>
                                    <li>Click on any place to see it on the map</li>
                                    <li>Check opening hours and contact information</li>
                                </ul>
                            </div>
                            
                            <button class="brutal-btn" onclick="document.getElementById('aiRefinementInput').value = ''; searchNearby();" style="margin-top: 20px; width: 100%;">
                                üîÑ CLEAR REFINEMENT & SEARCH AGAIN
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Search nearby services
        async function searchNearby() {
            const searchInput = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchInput) {
                alert('Please enter what you\'re looking for (e.g., hospital, pharmacy, restaurant)');
                return;
            }

            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            
            // Scroll to loading state
            document.getElementById('loadingState').scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Clear previous markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Clear previous results
            document.getElementById('grid5km').innerHTML = '';
            document.getElementById('grid10km').innerHTML = '';
            document.getElementById('grid50km').innerHTML = '';
            document.getElementById('aiRecommendationsGrid').innerHTML = '';

            const allResults = [];

            // Map common search terms to OpenStreetMap categories
            const searchTermMap = {
                'hospital': 'hospital',
                'hospitals': 'hospital',
                'clinic': 'hospital',
                'medical': 'hospital',
                'pharmacy': 'pharmacy',
                'pharmacies': 'pharmacy',
                'chemist': 'pharmacy',
                'medicine': 'pharmacy',
                'police': 'police',
                'police station': 'police',
                'fire': 'fire_station',
                'fire station': 'fire_station',
                'restaurant': 'restaurant',
                'restaurants': 'restaurant',
                'food': 'restaurant',
                'dining': 'restaurant',
                'eat': 'restaurant',
                'bank': 'bank',
                'banks': 'bank',
                'atm': 'atm',
                'atms': 'atm',
                'cash': 'atm',
                'school': 'school',
                'schools': 'school',
                'education': 'school',
                'park': 'park',
                'parks': 'park',
                'garden': 'park',
                'fuel': 'fuel',
                'gas': 'fuel',
                'petrol': 'fuel',
                'gas station': 'fuel',
                'petrol pump': 'fuel'
            };

            // Find matching category
            let matchedCategory = null;
            for (const [term, category] of Object.entries(searchTermMap)) {
                if (searchInput.includes(term)) {
                    matchedCategory = category;
                    break;
                }
            }

            if (!matchedCategory) {
                alert(`Sorry, "${searchInput}" is not recognized. Try: hospital, pharmacy, restaurant, bank, atm, police, fire station, school, park, or fuel station`);
                document.getElementById('loadingState').style.display = 'none';
                return;
            }

            // Build Overpass query
            const radius = 50000; // 50km in meters
            const query = categoryQueries[matchedCategory];
            const overpassQuery = `
                [out:json][timeout:25];
                (
                    ${query}(around:${radius},${userLocation.lat},${userLocation.lon});
                );
                out body;
            `;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery
                });

                const data = await response.json();
                
                console.log(`Found ${data.elements.length} places`);

                // Process results
                data.elements.forEach(element => {
                    if (element.lat && element.lon && element.tags) {
                        const distance = calculateDistance(
                            userLocation.lat,
                            userLocation.lon,
                            element.lat,
                            element.lon
                        );

                        // Determine category
                        let category = 'other';
                        if (element.tags.amenity) {
                            category = element.tags.amenity;
                        } else if (element.tags.leisure) {
                            category = element.tags.leisure;
                        }

                        const place = {
                            name: element.tags.name || `${category} (unnamed)`,
                            category: category,
                            distance: distance,
                            lat: element.lat,
                            lon: element.lon,
                            address: element.tags['addr:full'] || element.tags['addr:street'] || 'Address not available',
                            phone: element.tags.phone || element.tags['contact:phone'] || null,
                            website: element.tags.website || element.tags['contact:website'] || null,
                            email: element.tags.email || element.tags['contact:email'] || null,
                            openingHours: element.tags.opening_hours || null,
                            wheelchair: element.tags.wheelchair || null,
                            cuisine: element.tags.cuisine || null,
                            rating: element.tags['stars'] || null,
                            capacity: element.tags.capacity || null,
                            operator: element.tags.operator || null,
                            brand: element.tags.brand || null,
                            tags: element.tags // Store ALL OpenStreetMap tags for AI context
                        };

                        allResults.push(place);
                    }
                });

                // Sort by distance
                allResults.sort((a, b) => a.distance - b.distance);

                // Get AI recommendations
                await getAIRecommendations(allResults, matchedCategory);

                // Group by distance
                const within5km = allResults.filter(p => p.distance <= 5);
                const within10km = allResults.filter(p => p.distance > 5 && p.distance <= 10);
                const within50km = allResults.filter(p => p.distance > 10 && p.distance <= 50);

                // Update section headers with counts
                const count5km = within5km.length > 2000 ? '2000+' : within5km.length;
                const count10km = within10km.length > 2000 ? '2000+' : within10km.length;
                const count50km = within50km.length > 2000 ? '2000+' : within50km.length;
                
                document.querySelector('#results5km h2').textContent = `üìç WITHIN 5 KM (${count5km})`;
                document.querySelector('#results10km h2').textContent = `üìç 5-10 KM (${count10km})`;
                document.querySelector('#results50km h2').textContent = `üìç 10-50 KM (${count50km})`;

                // Display results
                displayResults(within5km, 'grid5km');
                displayResults(within10km, 'grid10km');
                displayResults(within50km, 'grid50km');

                // Add markers to map
                allResults.slice(0, 100).forEach(place => {
                    const marker = L.marker([place.lat, place.lon]).addTo(map);
                    marker.bindPopup(`
                        <strong>${categoryIcons[place.category] || 'üìç'} ${place.name}</strong><br>
                        Distance: ${place.distance.toFixed(2)} km
                    `);
                    markers.push(marker);
                });

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="brutal-alert brutal-alert-error">
                        <strong>ERROR FETCHING DATA</strong><br>
                        ${error.message}<br><br>
                        <button class="brutal-btn" onclick="searchNearby()">TRY AGAIN</button>
                    </div>
                `;
            }
        }

        // Get AI recommendations for best places
        async function getAIRecommendations(allPlaces, category) {
            const grid = document.getElementById('aiRecommendationsGrid');
            const aiSection = document.getElementById('aiRecommendations');
            
            if (allPlaces.length === 0) {
                aiSection.style.display = 'none';
                return;
            }

            // Show AI section
            aiSection.style.display = 'block';
            grid.innerHTML = '<div class="brutal-loading" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto;"></div><p style="margin-top: 10px; text-align: center; font-family: \'Space Mono\', monospace;">AI is analyzing the best options...</p>';

            try {
                const recommendations = [];

                // Get top 5 closest places
                const topPlaces = allPlaces.slice(0, 5);
                    
                
                const context = {
                    category: category,
                    places: topPlaces.map(p => ({
                        name: p.name,
                        distance: p.distance.toFixed(2) + ' km',
                        openingHours: p.openingHours || 'Unknown',
                        brand: p.brand || 'Independent',
                        operator: p.operator || 'Unknown',
                        wheelchair: p.wheelchair || 'Unknown'
                    })),
                    userLocation: userLocation,
                    currentTime: new Date().toISOString()
                };

                try {
                    let aiMessage = `From these ${category} options, which ONE is the best choice right now and why? Consider distance, brand reputation, and opening hours. Respond in 2-3 sentences max. Options: ${topPlaces.map(p => `${p.name} (${p.distance.toFixed(2)}km)`).join(', ')}`;

                    const response = await fetch('/api/ai/ai-query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: aiMessage,
                            context: context,
                            enableWebSearch: true // Enable web search for better recommendations
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log(`AI response for ${category}:`, data.response);
                        
                        // Find the recommended place (first one mentioned or closest)
                        let recommendedPlace = topPlaces[0];
                        for (const place of topPlaces) {
                            if (data.response.toLowerCase().includes(place.name.toLowerCase())) {
                                recommendedPlace = place;
                                break;
                            }
                        }

                        recommendations.push({
                            place: recommendedPlace,
                            reason: data.response || `${recommendedPlace.name} is recommended as the best ${category} option at ${recommendedPlace.distance.toFixed(2)}km.`,
                            category: category
                        });
                        
                        console.log(`Added AI recommendation for ${category}:`, recommendedPlace.name);
                    } else {
                        console.error(`AI API returned error status: ${response.status}`);
                        throw new Error(`API error: ${response.status}`);
                    }
                } catch (error) {
                    console.error(`AI recommendation error for ${category}:`, error);
                    // Fallback: recommend closest with smart reason
                    const place = topPlaces[0];
                    let reason = '';
                    
                    if (category === 'hospital') {
                        reason = `${place.name} is recommended as the closest hospital at ${place.distance.toFixed(2)}km, ensuring quick access for medical emergencies.`;
                    } else if (category === 'pharmacy') {
                        reason = `${place.name} is the nearest pharmacy at ${place.distance.toFixed(2)}km, convenient for urgent medication needs.`;
                    } else if (category === 'bank' || category === 'atm') {
                        reason = `${place.name} is the closest ${category} at ${place.distance.toFixed(2)}km for your banking needs.`;
                    } else if (category === 'restaurant') {
                        reason = `${place.name} is the nearest dining option at ${place.distance.toFixed(2)}km from your location.`;
                    } else {
                        reason = `${place.name} is the closest ${category} at ${place.distance.toFixed(2)}km with good accessibility.`;
                    }
                    
                    recommendations.push({
                        place: place,
                        reason: reason,
                        category: category
                    });
                }


                // Display recommendations
                console.log(`Total recommendations to display: ${recommendations.length}`, recommendations);
                
                if (recommendations.length > 0) {
                    const htmlParts = [];
                    
                    for (let i = 0; i < recommendations.length; i++) {
                        const rec = recommendations[i];
                        const tileId = `ai-tile-${i}`;
                        
                        // Store complete place data for AI context
                        allPlacesData[tileId] = rec.place;
                        
                        // Safely escape all text content
                        const safeName = (rec.place.name || 'Unknown').replace(/[<>&"']/g, c => ({
                            '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
                        })[c]);
                        
                        const safeAddress = (rec.place.address || 'Address not available').replace(/[<>&"']/g, c => ({
                            '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
                        })[c]);
                        
                        const safeReason = (rec.reason || 'Recommended option').replace(/[<>&"']/g, c => ({
                            '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
                        })[c]);
                        
                        const safeCategory = (rec.category || 'service').toUpperCase();
                        
                        const cardHtml = `
                        <div class="brutal-card ai-recommendation-card" id="${tileId}">
                            <div class="brutal-card-header ai-rec-header">
                                <div style="width: 100%;">
                                    <div style="font-size: 36px; margin-bottom: 5px;">‚≠ê</div>
                                    <h3 class="ai-rec-title">
                                        AI PICK: ${safeName}
                                    </h3>
                                    <p class="ai-rec-subtitle">
                                        ${safeCategory}
                                    </p>
                                </div>
                            </div>
                            <div class="brutal-card-body ai-rec-body">
                                <!-- AI Chat Section (Scrollable) -->
                                <div class="ai-chat-section">
                                    <label class="ai-chat-label">
                                        üí¨ ASK AI ABOUT THIS PLACE
                                    </label>
                                    
                                    <!-- Scrollable Chat Container -->
                                    <div id="${tileId}-chat" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px; padding: 8px; background: #f9f9f9; border: 2px solid #e0e0e0;">
                                        <p style="font-size: 12px; color: #666; font-style: italic; margin: 0;">
                                            üåê AI searches the web for current information about this place
                                        </p>
                                    </div>
                                    
                                    <!-- Input Area -->
                                    <div style="display: flex; gap: 8px;">
                                        <input 
                                            type="text" 
                                            id="${tileId}-refine-input" 
                                            placeholder="Ask about hours, parking, accessibility..."
                                            class="brutal-input"
                                            style="flex: 1; font-size: 12px; padding: 8px;"
                                            onkeypress="if(event.key==='Enter') refineSingleRecommendation('${tileId}')"
                                        />
                                        <button 
                                            class="brutal-btn" 
                                            onclick="refineSingleRecommendation('${tileId}')" 
                                            style="padding: 8px 12px; font-size: 11px; white-space: nowrap;">
                                            üì§ ASK
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Place Details -->
                                <div style="background: #f0f0f0; border: 2px solid #000; padding: 12px; margin-bottom: 15px; font-size: 13px;">
                                    <strong style="font-family: 'Space Mono', monospace; color: #7b2cbf; display: block; margin-bottom: 8px;">üìã PLACE DETAILS:</strong>
                                    
                                    <div style="margin-bottom: 6px;">
                                        <strong>üìç Address:</strong> ${safeAddress}
                                    </div>
                                    
                                    <div style="margin-bottom: 6px;">
                                        <strong>üìè Distance:</strong> ${rec.place.distance.toFixed(2)} km
                                    </div>
                                    
                                    ${rec.place.openingHours ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>üïê Hours:</strong> ${rec.place.openingHours}
                                        </div>
                                    ` : ''}
                                    
                                    ${rec.place.phone ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>üìû Phone:</strong> <a href="tel:${rec.place.phone}" style="color: #7b2cbf;">${rec.place.phone}</a>
                                        </div>
                                    ` : ''}
                                    
                                    ${rec.place.email ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>üìß Email:</strong> <a href="mailto:${rec.place.email}" style="color: #7b2cbf;">${rec.place.email}</a>
                                        </div>
                                    ` : ''}
                                    
                                    ${rec.place.website ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>üåê Website:</strong> <a href="${rec.place.website}" target="_blank" style="color: #7b2cbf;">Visit</a>
                                        </div>
                                    ` : ''}
                                    
                                    ${rec.place.wheelchair ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>‚ôø Wheelchair:</strong> ${rec.place.wheelchair === 'yes' ? '‚úÖ Accessible' : rec.place.wheelchair === 'no' ? '‚ùå Not Accessible' : 'Unknown'}
                                        </div>
                                    ` : ''}
                                    
                                    ${rec.place.brand ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>üè∑Ô∏è Brand:</strong> ${rec.place.brand}
                                        </div>
                                    ` : ''}
                                    
                                    ${rec.place.operator ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>üë§ Operator:</strong> ${rec.place.operator}
                                        </div>
                                    ` : ''}
                                    
                                    ${rec.place.cuisine ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>üç¥ Cuisine:</strong> ${rec.place.cuisine}
                                        </div>
                                    ` : ''}
                                    
                                    ${rec.place.capacity ? `
                                        <div style="margin-bottom: 6px;">
                                            <strong>üë• Capacity:</strong> ${rec.place.capacity}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Action Buttons -->
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="brutal-btn" onclick="showOnMap(${rec.place.lat}, ${rec.place.lon}, '${safeName.replace(/'/g, "\\'")}')" style="flex: 1; padding: 10px; font-size: 12px;">
                                        üìç SHOW ON MAP
                                    </button>
                                    ${rec.place.website ? `
                                        <a href="${rec.place.website}" target="_blank" class="brutal-btn" style="flex: 1; padding: 10px; font-size: 12px; text-decoration: none; text-align: center;">
                                            üåê WEBSITE
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>`;
                        
                        htmlParts.push(cardHtml);
                    }
                    
                    grid.innerHTML = htmlParts.join('');
                    console.log('AI recommendations HTML inserted. Grid innerHTML length:', grid.innerHTML.length);
                    console.log('Grid children count:', grid.children.length);
                    console.log('Grid display style:', window.getComputedStyle(grid).display);
                } else {
                    grid.innerHTML = '<p style="color: #808080; text-align: center; padding: 40px; font-family: \'Space Mono\', monospace;">No recommendations available for selected categories</p>';
                }

            } catch (error) {
                console.error('AI recommendations error:', error);
                grid.innerHTML = `<p style="color: #FF0000; text-align: center; padding: 40px; font-family: 'Space Mono', monospace;">Error loading AI recommendations: ${error.message}</p>`;
            }
        }

        // Display results
        function displayResults(places, gridId) {
            const grid = document.getElementById(gridId);
            
            if (places.length === 0) {
                grid.innerHTML = '<p style="color: #808080;">No services found in this range</p>';
                return;
            }

            grid.innerHTML = places.map((place, index) => {
                const tileId = `place-${gridId}-${index}`;
                
                // Store place data for AI context
                allPlacesData[tileId] = place;
                
                // Determine if open now
                let openStatus = '';
                if (place.openingHours) {
                    const isOpen = checkIfOpen(place.openingHours);
                    openStatus = isOpen 
                        ? '<span class="brutal-tag brutal-tag-green" style="font-size: 11px;">üü¢ OPEN</span>'
                        : '<span class="brutal-tag" style="background: #FF0000; color: #fff; font-size: 11px;">üî¥ CLOSED</span>';
                }
                
                return `
                <div class="brutal-card">
                    <div class="brutal-card-header" onclick="showOnMap(${place.lat}, ${place.lon}, '${place.name.replace(/'/g, "\\'")}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; width: 100%;">
                            <div>
                                <div class="brutal-icon">${categoryIcons[place.category] || 'üìç'}</div>
                                <h3 style="font-size: 18px; margin: 0;">${place.name}</h3>
                                ${place.brand ? `<p style="font-size: 12px; color: #9d4edd; margin-top: 5px;">${place.brand}</p>` : ''}
                            </div>
                            ${openStatus}
                        </div>
                    </div>
                    <div class="brutal-card-body">
                        <p style="margin-bottom: 10px; color: #808080; font-size: 14px;">
                            ${place.address}
                        </p>
                        
                        <div style="font-family: 'Space Mono', monospace; font-size: 14px; margin-bottom: 10px;">
                            <strong>üìè Distance:</strong> ${place.distance.toFixed(2)} km
                        </div>
                        
                        ${place.openingHours ? `
                            <div style="font-family: 'Space Mono', monospace; font-size: 12px; margin-bottom: 10px; padding: 8px; background: #f0f0f0; border: 2px solid #000;">
                                <strong>üïê Hours:</strong> ${place.openingHours}
                            </div>
                        ` : ''}
                        
                        ${place.phone ? `
                            <div style="font-family: 'Space Mono', monospace; font-size: 14px; margin-bottom: 10px;">
                                <strong>üìû Phone:</strong> <a href="tel:${place.phone}" style="color: #7b2cbf;">${place.phone}</a>
                            </div>
                        ` : ''}
                        
                        ${place.email ? `
                            <div style="font-family: 'Space Mono', monospace; font-size: 14px; margin-bottom: 10px;">
                                <strong>üìß Email:</strong> <a href="mailto:${place.email}" style="color: #7b2cbf;">${place.email}</a>
                            </div>
                        ` : ''}
                        
                        ${place.cuisine ? `
                            <div style="margin-bottom: 10px;">
                                <span class="brutal-tag" style="font-size: 11px;">üç¥ ${place.cuisine.toUpperCase()}</span>
                            </div>
                        ` : ''}
                        
                        ${place.wheelchair === 'yes' ? `
                            <div style="margin-bottom: 10px;">
                                <span class="brutal-tag brutal-tag-cyan" style="font-size: 11px;">‚ôø ACCESSIBLE</span>
                            </div>
                        ` : ''}
                        
                        ${place.website ? `
                            <a href="${place.website}" target="_blank" class="brutal-tag" style="display: inline-block; margin-bottom: 10px; text-decoration: none;">
                                üåê WEBSITE
                            </a>
                        ` : ''}
                        
                        <!-- AI Chat Section -->
                        <div class="ai-chat-section">
                            <label class="ai-chat-label">
                                üí¨ ASK AI ABOUT THIS PLACE
                            </label>
                            
                            <!-- Scrollable Chat Container -->
                            <div id="${tileId}-chat" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px; padding: 8px; background: #f9f9f9; border: 2px solid #e0e0e0;">
                                <p style="font-size: 12px; color: #666; font-style: italic; margin: 0;">
                                    üåê AI searches the web for current information about this place
                                </p>
                            </div>
                            
                            <!-- Input Area -->
                            <div style="display: flex; gap: 8px;">
                                <input 
                                    type="text" 
                                    id="${tileId}-refine-input" 
                                    placeholder="Ask about hours, parking, accessibility..."
                                    class="brutal-input"
                                    style="flex: 1; font-size: 12px; padding: 8px;"
                                    onkeypress="if(event.key==='Enter') refineSingleRecommendation('${tileId}')"
                                />
                                <button 
                                    class="brutal-btn" 
                                    onclick="refineSingleRecommendation('${tileId}')" 
                                    style="padding: 8px 12px; font-size: 11px; white-space: nowrap;">
                                    üì§ ASK
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Check if place is open now
        function checkIfOpen(openingHours) {
            // Simple check - this is a basic implementation
            // OpenStreetMap opening_hours can be complex
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            
            // Check for 24/7
            if (openingHours.includes('24/7')) return true;
            
            // Check for common patterns
            const lowerHours = openingHours.toLowerCase();
            
            // Weekend check
            if ((day === 0 || day === 6) && lowerHours.includes('closed') && lowerHours.includes('weekend')) {
                return false;
            }
            
            // Basic hour check (simplified)
            if (hour >= 9 && hour < 18) {
                return !lowerHours.includes('closed');
            }
            
            return null; // Unknown
        }

        // Show place on map
        function showOnMap(lat, lon, name) {
            map.setView([lat, lon], 16);
            markers.forEach(marker => {
                const markerLatLng = marker.getLatLng();
                if (markerLatLng.lat === lat && markerLatLng.lng === lon) {
                    marker.openPopup();
                }
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Language switching
        function changeLanguage(lang) {
            if (window.LanguageManager) {
                window.LanguageManager.changeLanguage(lang);
            }
        }

        // Accessibility functions
        function toggleAccessibility() {
            const panel = document.getElementById('accessibilityPanel');
            panel.classList.toggle('active');
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            document.getElementById('lightBtn').classList.toggle('active', theme === 'light');
            document.getElementById('darkBtn').classList.toggle('active', theme === 'dark');
        }

        function setFontSize(size) {
            document.body.className = document.body.className.replace(/font-size-\w+/g, '');
            document.body.classList.add(`font-size-${size}`);
            localStorage.setItem('fontSize', size);
            
            document.querySelectorAll('.accessibility-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Load saved preferences
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const savedFontSize = localStorage.getItem('fontSize') || 'normal';
            
            setTheme(savedTheme);
            document.body.classList.add(`font-size-${savedFontSize}`);
            
            // Close accessibility panel when clicking outside
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('accessibilityPanel');
                const isAccessibilityBtn = e.target.closest('[onclick="toggleAccessibility()"]');
                const isInsidePanel = e.target.closest('.accessibility-panel');
                
                if (!isAccessibilityBtn && !isInsidePanel && panel.classList.contains('active')) {
                    panel.classList.remove('active');
                }
            });
            
            // Automatically request location on page load
            console.log('Page loaded - requesting GPS location automatically...');
            requestLocation();
        });

        // Context gathering for AI
        globalThis.gatherPageContextFixed = function() {
            return {
                page: window.location.pathname,
                pageName: document.title,
                pageType: 'nearby-services',
                timestamp: new Date().toISOString(),
                language: localStorage.getItem('language') || 'en',
                
                location: userLocation ? {
                    latitude: userLocation.lat,
                    longitude: userLocation.lon,
                    hasLocation: true
                } : {
                    hasLocation: false
                },
                
                selectedCategories: Array.from(selectedCategories),
                
                capabilities: [
                    'Find nearby hospitals, police stations, banks, ATMs, restaurants, etc.',
                    'Uses real-time data from OpenStreetMap',
                    'Groups results by distance (5km, 10km, 50km)',
                    'Shows locations on interactive map',
                    'Provides contact information and directions'
                ],
                
                description: userLocation 
                    ? `User is viewing nearby services at location ${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}. Selected categories: ${Array.from(selectedCategories).join(', ') || 'none'}.`
                    : 'User has not yet enabled location access.'
            };
        };
    </script>
</body>
</html>
