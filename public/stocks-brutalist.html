<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIVE STOCKS - BRUTALIST</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/brutalist-style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Brutalist Header -->
    <header class="brutal-header">
        <h1 class="brutal-title">LIVE STOCK MARKET</h1>
        <p class="brutal-subtitle">Real-Time NSE Data ‚Ä¢ 2000+ Stocks ‚Ä¢ AI Analysis</p>
        <nav class="brutal-nav">
            <a href="javascript:history.back()" class="brutal-nav-btn">‚Üê BACK</a>
            <a href="/index-brutalist.html" class="brutal-nav-btn">HOME</a>
            <a href="/services-brutalist.html" class="brutal-nav-btn">SERVICES</a>
            <a href="/stocks-brutalist.html" class="brutal-nav-btn active">STOCKS</a>
            <a href="/market-brutalist.html" class="brutal-nav-btn">MARKET</a>
            <a href="/nearby-brutalist.html" class="brutal-nav-btn">NEARBY</a>
            <a href="/login-brutalist.html" class="brutal-nav-btn">LOGIN</a>
            <select class="brutal-select" id="languageSelector" onchange="changeLanguage(this.value)">
                <option value="en">ENGLISH</option>
                <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
            </select>
            <button class="brutal-btn" onclick="toggleAccessibility()" style="padding: 10px 15px;">
                ‚öôÔ∏è ACCESSIBILITY
            </button>
        </nav>
    </header>

    <!-- Accessibility Panel -->
    <div class="accessibility-panel" id="accessibilityPanel">
        <h3>‚öôÔ∏è SETTINGS</h3>
        
        <div class="accessibility-option">
            <label>Theme</label>
            <div class="accessibility-buttons">
                <button class="accessibility-btn active" onclick="setTheme('light')" id="lightBtn">
                    ‚òÄÔ∏è LIGHT
                </button>
                <button class="accessibility-btn" onclick="setTheme('dark')" id="darkBtn">
                    üåô DARK
                </button>
            </div>
        </div>

        <div class="accessibility-option">
            <label>Font Size</label>
            <div class="accessibility-buttons">
                <button class="accessibility-btn" onclick="setFontSize('small')">
                    A-
                </button>
                <button class="accessibility-btn active" onclick="setFontSize('normal')" id="normalFontBtn">
                    A
                </button>
                <button class="accessibility-btn" onclick="setFontSize('large')">
                    A+
                </button>
                <button class="accessibility-btn" onclick="setFontSize('xlarge')">
                    A++
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="brutal-container">
        <!-- Search & Filter -->
        <div style="background: #fff; border: 6px solid #000; padding: 30px; margin-bottom: 30px;">
            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: center;">
                <input 
                    type="text" 
                    class="brutal-input" 
                    id="stockSearch" 
                    placeholder="SEARCH STOCKS (SYMBOL OR NAME)..."
                    style="margin: 0;"
                >
                <select class="brutal-select" id="sectorFilter" onchange="filterStocks()">
                    <option value="">ALL SECTORS</option>
                    <option value="Energy">ENERGY</option>
                    <option value="Finance">FINANCE</option>
                    <option value="IT">IT</option>
                    <option value="Auto">AUTO</option>
                    <option value="Pharma">PHARMA</option>
                </select>
                <button class="brutal-btn" onclick="loadStocks()">REFRESH</button>
            </div>
        </div>

        <!-- Market Status -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="brutal-stat">
                <span class="brutal-stat-number" id="totalStocks">0</span>
                <span class="brutal-stat-label">TOTAL STOCKS</span>
            </div>
            <div class="brutal-stat">
                <span class="brutal-stat-number" style="color: #00FF00;" id="gainers">0</span>
                <span class="brutal-stat-label">GAINERS</span>
            </div>
            <div class="brutal-stat">
                <span class="brutal-stat-number" style="color: #FF0000;" id="losers">0</span>
                <span class="brutal-stat-label">LOSERS</span>
            </div>
            <div class="brutal-stat">
                <span class="brutal-stat-number" id="marketStatus">LOADING</span>
                <span class="brutal-stat-label">MARKET STATUS</span>
            </div>
        </div>

        <!-- Loading Progress Bar -->
        <div id="loadingProgress" style="margin-bottom: 30px; background: #fff; border: 4px solid #7b2cbf; padding: 20px; display: none; box-shadow: 0 4px 0 #000;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700; color: #000;">
                    üìä LOADING STOCKS...
                </span>
                <span id="progressText" style="font-family: 'Space Mono', monospace; font-size: 14px; color: #7b2cbf; font-weight: 700;">
                    0 / 2000
                </span>
            </div>
            <div style="width: 100%; height: 16px; background: #e0e0e0; border-radius: 8px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);">
                <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #7b2cbf, #9d4edd, #c77dff); width: 0%; transition: width 0.3s ease; box-shadow: 0 0 10px rgba(123, 44, 191, 0.5);"></div>
            </div>
            <div style="margin-top: 10px; font-family: 'Space Mono', monospace; font-size: 12px; color: #666;">
                <span id="progressStatus">Initializing...</span>
            </div>
        </div>

        <!-- Stocks Grid -->
        <div id="stocksGrid" class="brutal-grid">
            <!-- Stocks loaded here -->
        </div>

        <!-- Bottom Loading Indicator -->
        <div id="bottomLoadingIndicator" style="margin-top: 30px; padding: 20px; background: #fff; border: 4px solid #7b2cbf; text-align: center; display: none; box-shadow: 0 4px 0 #000;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div class="brutal-loading" style="width: 30px; height: 30px; border-width: 4px;"></div>
                <div>
                    <div style="font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 700; color: #000;">
                        LOADING MORE STOCKS...
                    </div>
                    <div style="font-family: 'Space Mono', monospace; font-size: 12px; color: #7b2cbf; margin-top: 5px;">
                        <span id="bottomProgressText">Loading batch...</span>
                    </div>
                </div>
            </div>
            <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 15px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);">
                <div id="bottomProgressBar" style="height: 100%; background: linear-gradient(90deg, #7b2cbf, #9d4edd); width: 0%; transition: width 0.3s ease;"></div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" style="text-align: center; padding: 60px;">
            <div class="brutal-loading" style="width: 60px; height: 60px; border-width: 6px;"></div>
            <p style="font-family: 'Space Mono', monospace; font-size: 18px; margin-top: 20px; text-transform: uppercase;">
                LOADING STOCKS...
            </p>
        </div>
    </div>

    <!-- Stock Detail Modal -->
    <div class="brutal-modal" id="stockModal">
        <div class="brutal-modal-content">
            <div class="brutal-modal-header">
                <h2 id="modalStockName" style="font-size: 32px; margin: 0;"></h2>
                <button class="brutal-modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="brutal-modal-body">
                <div id="modalStockDetails"></div>
                <div style="margin-top: 30px;">
                    <canvas id="stockChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Manager -->
    <script src="/language-manager.js?v=1.0"></script>
    
    <!-- Comprehensive Context Gathering for AI -->
    <script>
        // Global context gathering function for AI chat
        globalThis.gatherPageContextFixed = function() {
            const context = {
                page: window.location.pathname,
                pageName: document.title,
                pageType: 'stocks',
                timestamp: new Date().toISOString(),
                language: localStorage.getItem('language') || 'en',
                
                // Stock data context
                stocks: {
                    total: allStocks.length,
                    displayed: filteredStocks.length,
                    loading: isLoading,
                    currentOffset: currentOffset,
                    estimatedTotal: estimatedTotal,
                    
                    // Sample of visible stocks
                    visibleStocks: filteredStocks.slice(0, 20).map(stock => ({
                        symbol: stock.symbol,
                        name: stock.name,
                        price: stock.currentPrice || stock.price,
                        change: stock.change,
                        changePercent: stock.changePercent,
                        sector: stock.sector,
                        exchange: stock.exchange
                    })),
                    
                    // Market statistics
                    stats: {
                        totalStocks: allStocks.length,
                        gainers: allStocks.filter(s => parseFloat(s.change) > 0).length,
                        losers: allStocks.filter(s => parseFloat(s.change) < 0).length,
                        marketStatus: 'OPEN'
                    },
                    
                    // Sector breakdown
                    sectors: [...new Set(allStocks.map(s => s.sector))].filter(Boolean),
                    
                    // Top gainers
                    topGainers: allStocks
                        .filter(s => s.changePercent)
                        .sort((a, b) => parseFloat(b.changePercent) - parseFloat(a.changePercent))
                        .slice(0, 5)
                        .map(s => ({
                            symbol: s.symbol,
                            name: s.name,
                            change: s.changePercent + '%'
                        })),
                    
                    // Top losers
                    topLosers: allStocks
                        .filter(s => s.changePercent)
                        .sort((a, b) => parseFloat(a.changePercent) - parseFloat(b.changePercent))
                        .slice(0, 5)
                        .map(s => ({
                            symbol: s.symbol,
                            name: s.name,
                            change: s.changePercent + '%'
                        }))
                },
                
                // Search/filter context
                filters: {
                    searchQuery: document.getElementById('stockSearch')?.value || '',
                    selectedSector: document.getElementById('sectorFilter')?.value || 'all'
                },
                
                // UI state
                ui: {
                    progressBarVisible: document.getElementById('loadingProgress')?.style.display !== 'none',
                    bottomIndicatorVisible: document.getElementById('bottomLoadingIndicator')?.style.display !== 'none'
                },
                
                // Page capabilities
                capabilities: [
                    'View 2000+ live stock prices from NSE',
                    'Search stocks by symbol or name',
                    'Filter by sector (Energy, Finance, IT, Auto, Pharma, etc.)',
                    'View detailed stock information including price, change, volume',
                    'See top gainers and losers',
                    'Real-time market data with background loading',
                    'Multi-language support (English, Hindi, Tamil, Telugu, Bengali)'
                ],
                
                description: `User is viewing the Live Stocks page with ${allStocks.length} stocks loaded. ` +
                            `Currently displaying ${filteredStocks.length} stocks. ` +
                            `Market status: OPEN. ` +
                            `${allStocks.filter(s => parseFloat(s.change) > 0).length} gainers, ` +
                            `${allStocks.filter(s => parseFloat(s.change) < 0).length} losers.`
            };
            
            return context;
        };
    </script>
    
    <!-- AI Chat Floating Window -->
    <script src="/ai-chat-floating.js?v=2.1"></script>

    <script>
        let allStocks = [];
        let filteredStocks = [];
        let stockChart = null;
        let currentOffset = 0;
        const chunkSize = 30;
        let isLoading = false;
        let estimatedTotal = 2000;

        // Update progress bar
        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressStatus = document.getElementById('progressStatus');
            const progressContainer = document.getElementById('loadingProgress');
            const bottomIndicator = document.getElementById('bottomLoadingIndicator');
            const bottomProgressBar = document.getElementById('bottomProgressBar');
            const bottomProgressText = document.getElementById('bottomProgressText');
            
            if (isLoading) {
                const percentage = Math.min((allStocks.length / estimatedTotal) * 100, 95);
                progressBar.style.width = percentage + '%';
                progressText.textContent = `${allStocks.length} / ${estimatedTotal}`;
                progressStatus.innerHTML = `Loading batch ${Math.floor(currentOffset / chunkSize)}...`;
                progressContainer.style.display = 'block';
                
                // Show bottom indicator after initial load
                if (allStocks.length > 30) {
                    bottomIndicator.style.display = 'block';
                    bottomProgressBar.style.width = percentage + '%';
                    bottomProgressText.textContent = `${allStocks.length} stocks loaded, fetching more...`;
                }
            } else {
                progressBar.style.width = '100%';
                progressText.textContent = `${allStocks.length} stocks loaded`;
                progressStatus.innerHTML = `‚úì Complete!`;
                
                bottomIndicator.style.display = 'none';
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 3000);
            }
        }

        // Load stocks in background continuously
        async function loadInBackground() {
            if (isLoading) return;
            isLoading = true;
            updateProgress();
            
            let consecutiveErrors = 0;
            const maxConsecutiveErrors = 5;
            let emptyResponses = 0;
            
            while (true) {
                try {
                    const response = await fetch(`/api/realdata/stocks/paginated?limit=${chunkSize}&offset=${currentOffset}`);
                    const data = await response.json();
                    
                    if (data.success && data.data.length > 0) {
                        allStocks.push(...data.data);
                        currentOffset += chunkSize;
                        consecutiveErrors = 0;
                        emptyResponses = 0;
                        
                        // Update display dynamically
                        filteredStocks = allStocks;
                        displayStocks();
                        updateStats();
                        updateProgress();
                        
                        console.log(`üì¶ Loaded ${data.data.length} stocks (total: ${allStocks.length}, offset: ${currentOffset})`);
                        
                        if (!data.hasMore) {
                            console.log('‚úÖ All stocks loaded!');
                            break;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else if (data.success && data.data.length === 0) {
                        emptyResponses++;
                        console.log(`‚ö†Ô∏è Empty response ${emptyResponses}/5`);
                        
                        if (emptyResponses >= 5) {
                            console.log('‚úÖ Reached end of data (5 empty responses)');
                            break;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        currentOffset += chunkSize;
                    } else {
                        console.log('‚úÖ Reached end of data');
                        break;
                    }
                } catch (error) {
                    consecutiveErrors++;
                    console.error(`‚ö†Ô∏è Error loading chunk at offset ${currentOffset}:`, error.message);
                    
                    if (consecutiveErrors >= maxConsecutiveErrors) {
                        console.log(`‚ùå Stopping after ${consecutiveErrors} consecutive errors`);
                        console.log(`‚úÖ Successfully loaded ${allStocks.length} stocks before errors`);
                        break;
                    }
                    
                    const waitTime = 2000 * consecutiveErrors;
                    console.log(`‚è≥ Retrying in ${waitTime/1000} seconds...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
            
            isLoading = false;
            updateProgress();
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('stocksGrid').style.display = 'grid';
            console.log(`‚úÖ Background loading complete: ${allStocks.length} total stocks`);
            estimatedTotal = allStocks.length;
        }

        // Initial quick load
        async function initialLoad() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('stocksGrid').style.display = 'none';
                
                const response = await fetch(`/api/realdata/stocks/paginated?limit=30&offset=0`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    allStocks = data.data;
                    currentOffset = data.data.length;
                    
                    console.log(`‚úÖ Initial load: ${data.data.length} stocks`);
                    
                    filteredStocks = allStocks;
                    displayStocks();
                    updateStats();
                    
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('stocksGrid').style.display = 'grid';
                    document.getElementById('loadingProgress').style.display = 'block';
                    
                    // Start background loading immediately
                    setTimeout(() => loadInBackground(), 500);
                } else {
                    throw new Error('No data available');
                }
            } catch (error) {
                console.error('Error in initial load:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="brutal-alert brutal-alert-error">
                        ERROR LOADING STOCKS<br>
                        ${error.message}<br><br>
                        <button class="brutal-btn" onclick="location.reload()">RELOAD PAGE</button>
                    </div>
                `;
            }
        }

        // Display stocks
        function displayStocks() {
            const grid = document.getElementById('stocksGrid');
            const displayCount = Math.min(filteredStocks.length, 100); // Show up to 100 at a time
            const stocks = filteredStocks.slice(0, displayCount);

            grid.innerHTML = stocks.map(stock => {
                const changeColor = parseFloat(stock.change) >= 0 ? '#00FF00' : '#FF0000';
                const changeSymbol = parseFloat(stock.change) >= 0 ? '‚ñ≤' : '‚ñº';
                
                return `
                    <div class="brutal-card" onclick="openStockModal('${stock.symbol}')">
                        <div class="brutal-card-header">
                            <h3 style="font-size: 24px; margin: 0;">${stock.symbol}</h3>
                            <p style="font-size: 14px; margin: 5px 0 0; color: #808080; text-transform: none;">
                                ${stock.name || 'N/A'}
                            </p>
                        </div>
                        <div class="brutal-card-body">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-family: 'Space Mono', monospace; font-size: 28px; font-weight: 700;">
                                        ‚Çπ${stock.currentPrice || stock.price || 'N/A'}
                                    </div>
                                    <div style="font-size: 16px; color: ${changeColor}; font-weight: 700;">
                                        ${changeSymbol} ${stock.change || '0'}%
                                    </div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; font-family: 'Space Mono', monospace;">
                                <div>HIGH: ${stock.dayHigh || 'N/A'}</div>
                                <div>LOW: ${stock.dayLow || 'N/A'}</div>
                                <div>VOL: ${stock.volume || 'N/A'}</div>
                                <div>${stock.exchange || 'NSE'}</div>
                            </div>
                            ${stock.sector ? `<span class="brutal-tag" style="margin-top: 10px;">${stock.sector}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalStocks').textContent = allStocks.length;
            
            const gainers = allStocks.filter(s => parseFloat(s.change) > 0).length;
            const losers = allStocks.filter(s => parseFloat(s.change) < 0).length;
            
            document.getElementById('gainers').textContent = gainers;
            document.getElementById('losers').textContent = losers;
            
            // Check actual market hours (IST: Monday-Friday, 9:15 AM - 3:30 PM)
            const now = new Date();
            const istOffset = 5.5 * 60; // IST is UTC+5:30
            const istTime = new Date(now.getTime() + (istOffset * 60 * 1000));
            const day = istTime.getUTCDay(); // 0 = Sunday, 6 = Saturday
            const hours = istTime.getUTCHours();
            const minutes = istTime.getUTCMinutes();
            const totalMinutes = hours * 60 + minutes;
            
            // Market hours: Monday (1) to Friday (5), 9:15 AM (555 min) to 3:30 PM (930 min)
            const isWeekday = day >= 1 && day <= 5;
            const isMarketHours = totalMinutes >= 555 && totalMinutes <= 930;
            const isMarketOpen = isWeekday && isMarketHours;
            
            const statusElement = document.getElementById('marketStatus');
            if (isMarketOpen) {
                statusElement.textContent = 'OPEN';
                statusElement.style.color = '#00FF00';
            } else {
                statusElement.textContent = 'CLOSED';
                statusElement.style.color = '#FF0000';
            }
        }

        // Filter stocks
        function filterStocks() {
            const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
            const sector = document.getElementById('sectorFilter').value;

            filteredStocks = allStocks.filter(stock => {
                const matchesSearch = !searchTerm || 
                    stock.symbol.toLowerCase().includes(searchTerm) ||
                    (stock.name && stock.name.toLowerCase().includes(searchTerm));
                
                const matchesSector = !sector || stock.sector === sector;
                
                return matchesSearch && matchesSector;
            });

            displayStocks();
        }

        // Open stock modal
        function openStockModal(symbol) {
            const stock = allStocks.find(s => s.symbol === symbol);
            if (!stock) return;

            document.getElementById('modalStockName').textContent = `${stock.symbol} - ${stock.name || 'N/A'}`;
            
            const changeColor = parseFloat(stock.change) >= 0 ? '#00FF00' : '#FF0000';
            
            document.getElementById('modalStockDetails').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="brutal-section">
                        <div class="brutal-section-title">PRICE</div>
                        <div style="font-family: 'Space Mono', monospace; font-size: 36px; font-weight: 700;">
                            ‚Çπ${stock.currentPrice || stock.price || 'N/A'}
                        </div>
                        <div style="font-size: 18px; color: ${changeColor}; font-weight: 700;">
                            ${stock.change || '0'}%
                        </div>
                    </div>
                    
                    <div class="brutal-section">
                        <div class="brutal-section-title">DAY RANGE</div>
                        <div style="font-family: 'Space Mono', monospace; font-size: 18px;">
                            HIGH: ‚Çπ${stock.dayHigh || 'N/A'}<br>
                            LOW: ‚Çπ${stock.dayLow || 'N/A'}
                        </div>
                    </div>
                    
                    <div class="brutal-section">
                        <div class="brutal-section-title">VOLUME</div>
                        <div style="font-family: 'Space Mono', monospace; font-size: 18px;">
                            ${stock.volume || 'N/A'}
                        </div>
                    </div>
                    
                    <div class="brutal-section">
                        <div class="brutal-section-title">INFO</div>
                        <div style="font-family: 'Space Mono', monospace; font-size: 14px;">
                            EXCHANGE: ${stock.exchange || 'NSE'}<br>
                            SECTOR: ${stock.sector || 'N/A'}<br>
                            ${stock.marketCap ? `CAP: ${stock.marketCap}` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Create simple chart
            createStockChart(stock);
            
            document.getElementById('stockModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('stockModal').classList.remove('active');
        }

        // Create stock chart
        function createStockChart(stock) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            if (stockChart) {
                stockChart.destroy();
            }

            // Generate sample data (in real app, fetch historical data)
            const labels = ['9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00'];
            const basePrice = parseFloat(stock.currentPrice || stock.price || 100);
            const data = labels.map(() => basePrice + (Math.random() - 0.5) * 20);

            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: stock.symbol,
                        data: data,
                        borderColor: '#000',
                        backgroundColor: 'rgba(255, 255, 0, 0.1)',
                        borderWidth: 4,
                        tension: 0,
                        pointRadius: 6,
                        pointBackgroundColor: '#FFFF00',
                        pointBorderColor: '#000',
                        pointBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: '#000',
                                lineWidth: 2
                            }
                        },
                        x: {
                            grid: {
                                color: '#000',
                                lineWidth: 2
                            }
                        }
                    }
                }
            });
        }

        // Language switching
        function changeLanguage(lang) {
            if (window.LanguageManager) {
                window.LanguageManager.changeLanguage(lang);
            }
        }

        // Accessibility functions
        function toggleAccessibility() {
            const panel = document.getElementById('accessibilityPanel');
            panel.classList.toggle('active');
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            document.getElementById('lightBtn').classList.toggle('active', theme === 'light');
            document.getElementById('darkBtn').classList.toggle('active', theme === 'dark');
        }

        function setFontSize(size) {
            document.body.className = document.body.className.replace(/font-size-\w+/g, '');
            document.body.classList.add(`font-size-${size}`);
            localStorage.setItem('fontSize', size);
            
            document.querySelectorAll('.accessibility-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Load saved preferences
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const savedFontSize = localStorage.getItem('fontSize') || 'normal';
            
            setTheme(savedTheme);
            document.body.classList.add(`font-size-${savedFontSize}`);
            
            // Close accessibility panel when clicking outside
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('accessibilityPanel');
                const isAccessibilityBtn = e.target.closest('[onclick="toggleAccessibility()"]');
                const isInsidePanel = e.target.closest('.accessibility-panel');
                
                if (!isAccessibilityBtn && !isInsidePanel && panel.classList.contains('active')) {
                    panel.classList.remove('active');
                }
            });
        });

        // Search on input
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('stockSearch').addEventListener('input', filterStocks);
            initialLoad();
            
            // Close modal on ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        });
    </script>
</body>
</html>
